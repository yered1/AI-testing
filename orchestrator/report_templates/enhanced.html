<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Engagement Report — Run {{ run_id }}</title>
  <style>
    body { font-family: -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; color: #222; }
    h1,h2,h3 { margin: 0.6em 0 0.3em }
    .meta { color: #666; font-size: 13px; margin-bottom: 10px; }
    .box { border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin: 12px 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #e5e5e5; padding: 8px; text-align: left; vertical-align: top; }
    th { background: #f8f8f8; }
    code { background: #f3f3f3; padding: 0 4px; border-radius: 3px; }
    .severity { font-weight: 600; }
  </style>
</head>
<body>
  <h1>Engagement Report</h1>
  <div class="meta">
    <div><strong>Run:</strong> {{ run_id }}</div>
    <div><strong>Generated:</strong> {{ generated_at }}</div>
    <div><strong>Engagement:</strong> {{ engagement.get('name','') }} ({{ engagement.get('type','') }})</div>
  </div>

  <h2>Plan</h2>
  <div class="box">
    {% if plan and plan.get('steps') %}
      <table>
        <tr><th>Step</th><th>Parameters</th></tr>
        {% for s in plan.get('steps') %}
          <tr>
            <td>{{ s.get('id') }}</td>
            <td><code>{{ (s.get('params') or {}) | tojson }}</code></td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <em>No plan steps recorded.</em>
    {% endif %}
  </div>

  <h2>Findings</h2>
  <div class="box">
    {% if findings_sorted %}
      <table>
        <tr><th>Title</th><th>Severity</th><th>Taxonomy</th><th>Description</th><th>Recommendation</th></tr>
        {% for f in findings_sorted %}
          <tr>
            <td><strong>{{ f.get('title','') }}</strong></td>
            <td class="severity">{{ f.get('severity','').upper() }}</td>
            <td>
              {% set t = f.get('tags') or {} %}
              {% if t.get('cwe') %}CWE: {{ t.get('cwe') }}<br/>{% endif %}
              {% if t.get('owasp') %}OWASP: {{ t.get('owasp') }} — {{ owasp.get(t.get('owasp')) or '' }}<br/>{% endif %}
              {% if t.get('cvss_score') %}CVSS: {{ t.get('cvss_score') }}{% if t.get('cvss_vector') %} ({{ t.get('cvss_vector') }}){% endif %}{% endif %}
            </td>
            <td>{{ f.get('description','') }}</td>
            <td>{{ f.get('recommendation') or '—' }}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <em>No findings recorded.</em>
    {% endif %}
  </div>

  <h2>Artifacts</h2>
  <div class="box">
    {% set arts = (artifacts or []) %}
    {% if arts %}
      <table>
        <tr><th>Label</th><th>Kind</th><th>Path</th></tr>
        {% for a in arts %}
          <tr>
            <td>{{ a.get('label') }}</td>
            <td>{{ a.get('kind') }}</td>
            <td><code>{{ a.get('path') }}</code></td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <em>No artifacts listed.</em>
    {% endif %}
  </div>
</body>
</html>
