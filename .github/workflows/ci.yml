name: CI v5 (build → migrate → api → smoke)

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Login to Docker Hub (anon)
        run: echo "using public pulls"

      - name: Migrate (DB+OPA up; alembic from /app/orchestrator)
        run: bash scripts/ci_migrate_v156.sh

      - name: Bring up full stack
        run: bash scripts/ci_stack_up_v156.sh

      - name: Wait for API
        run: bash scripts/wait_for_api_v156.sh

      - name: Smoke
        run: python scripts/ci_smoke.py

      - name: Print logs on fail
        if: failure()
        run: bash scripts/print_logs_on_fail_v156.sh
      - name: Build orchestrator
        run: docker compose -f infra/docker-compose.v2.yml build orchestrator
      - name: Migrate DB (CI)
        run: bash scripts/ci_migrate_v157.sh
      - name: Bring up stack
        run: bash scripts/ci_stack_up_v157.sh
      - name: Wait for API
        run: bash scripts/wait_for_api_v157.sh
